var N=Object.create,y=Object.defineProperty,O=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty,F=Object.getOwnPropertyNames,_=Object.getOwnPropertyDescriptor,R=t=>y(t,"__esModule",{value:!0}),j=(t,e)=>{R(t);for(var i in e)y(t,i,{get:e[i],enumerable:!0})},J=(t,e,i)=>{if(R(t),e&&typeof e=="object"||typeof e=="function")for(let n of F(e))!B.call(t,n)&&n!=="default"&&y(t,n,{get:()=>e[n],enumerable:!(i=_(e,n))||i.enumerable});return t},f=t=>t&&t.__esModule?t:J(y(t!=null?N(O(t)):{},"default",{value:t,enumerable:!0}),t);j(exports,{ArticlesRoutes:()=>x});var S=f(require("express")),s=f(require("../database/models/article.model")),h=f(require("../database/models/comment.model")),u=f(require("../database/models/user.model")),c=f(require("../utils/authentication"));const r=S.Router();r.param("article",function(t,e,i,n){s.Article.findOne({slug:n}).populate("author").then(function(o){return o?(t.article=o,i()):e.sendStatus(404)}).catch(i)}),r.param("comment",function(t,e,i,n){h.Comment.findById(n).then(function(o){return o?(t.comment=o,i()):e.sendStatus(404)}).catch(i)}),r.get("/",c.authentication.optional,function(t,e,i){const n={};let o=20,a=0;typeof t.query.limit!="undefined"&&(o=parseInt(t.query.limit)),typeof t.query.offset!="undefined"&&(a=parseInt(t.query.offset)),typeof t.query.tag!="undefined"&&(n.tagList={$in:[t.query.tag]}),Promise.all([t.query.author?u.User.findOne({username:t.query.author}):null,t.query.favorited?u.User.findOne({username:t.query.favorited}):null]).then(function(d){const p=d[0],m=d[1];return p&&(n.author=p._id),m?n._id={$in:m.favorites}:t.query.favorited&&(n._id={$in:[]}),Promise.all([s.Article.find(n).limit(Number(o)).skip(Number(a)).sort({createdAt:"desc"}).populate("author").exec(),s.Article.count(n).exec(),t.payload?u.User.findById(t.payload.id):null]).then(function(l){const g=l[0],b=l[1],v=l[2];return e.json({articles:g.map(function(I){return I.toJSONFor(v)}),articlesCount:b})})}).catch(i)}),r.get("/feed",c.authentication.required,function(t,e,i){let n=20,o=0;typeof t.query.limit!="undefined"&&(n=parseInt(t.query.limit)),typeof t.query.offset!="undefined"&&(o=parseInt(t.query.offset)),u.User.findById(t.payload.id).then(function(a){if(!a)return e.sendStatus(401);Promise.all([s.Article.find({author:{$in:a.following}}).limit(Number(n)).skip(Number(o)).populate("author").exec(),s.Article.count({author:{$in:a.following}})]).then(function(d){const p=d[0],m=d[1];return e.json({articles:p.map(function(l){return l.toJSONFor(a)}),articlesCount:m})}).catch(i)})}),r.post("/",c.authentication.required,function(t,e,i){u.User.findById(t.payload.id).then(function(n){if(!n)return e.sendStatus(401);const o=new s.Article(t.body.article);return o.author=n,o.save().then(function(){return console.log(o.author),e.json({article:o.toJSONFor(n)})})}).catch(i)}),r.get("/:article",c.authentication.optional,function(t,e,i){Promise.all([t.payload?u.User.findById(t.payload.id):null,t.article.populate("author").execPopulate()]).then(function(n){const o=n[0];return e.json({article:t.article.toJSONFor(o)})}).catch(i)}),r.put("/:article",c.authentication.required,function(t,e,i){u.User.findById(t.payload.id).then(function(n){if(t.article.author._id.toString()===t.payload.id.toString())typeof t.body.article.title!="undefined"&&(t.article.title=t.body.article.title),typeof t.body.article.description!="undefined"&&(t.article.description=t.body.article.description),typeof t.body.article.body!="undefined"&&(t.article.body=t.body.article.body),typeof t.body.article.tagList!="undefined"&&(t.article.tagList=t.body.article.tagList),t.article.save().then(function(o){return e.json({article:o.toJSONFor(n)})}).catch(i);else return e.sendStatus(403)})}),r.delete("/:article",c.authentication.required,function(t,e,i){u.User.findById(t.payload.id).then(function(n){return n?t.article.author._id.toString()===t.payload.id.toString()?t.article.remove().then(function(){return e.sendStatus(204)}):e.sendStatus(403):e.sendStatus(401)}).catch(i)}),r.post("/:article/favorite",c.authentication.required,function(t,e,i){const n=t.article._id;u.User.findById(t.payload.id).then(function(o){return o?o.favorite(n).then(function(){return t.article.updateFavoriteCount().then(function(a){return e.json({article:a.toJSONFor(o)})})}):e.sendStatus(401)}).catch(i)}),r.delete("/:article/favorite",c.authentication.required,function(t,e,i){const n=t.article._id;u.User.findById(t.payload.id).then(function(o){return o?o.unfavorite(n).then(function(){return t.article.updateFavoriteCount().then(function(a){return e.json({article:a.toJSONFor(o)})})}):e.sendStatus(401)}).catch(i)}),r.get("/:article/comments",c.authentication.optional,function(t,e,i){Promise.resolve(t.payload?u.User.findById(t.payload.id):null).then(function(n){return t.article.populate({path:"comments",populate:{path:"author"},options:{sort:{createdAt:"desc"}}}).execPopulate().then(function(o){return e.json({comments:t.article.comments.map(function(a){return a.toJSONFor(n)})})})}).catch(i)}),r.post("/:article/comments",c.authentication.required,function(t,e,i){u.User.findById(t.payload.id).then(function(n){if(!n)return e.sendStatus(401);const o=new h.Comment(t.body.comment);return o.article=t.article,o.author=n,o.save().then(function(){return t.article.comments.push(o),t.article.save().then(function(a){e.json({comment:o.toJSONFor(n)})})})}).catch(i)}),r.delete("/:article/comments/:comment",c.authentication.required,function(t,e,i){t.comment.author.toString()===t.payload.id.toString()?(t.article.comments.remove(t.comment._id),t.article.save().then(()=>h.Comment.find({_id:t.comment._id}).remove().exec()).then(function(){e.sendStatus(204)})):e.sendStatus(403)});const x=r;
